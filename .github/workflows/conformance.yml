name: MCP Conformance Tests

on:
  workflow_dispatch:
    inputs:
      python_only:
        description: 'Run only Python conformance tests'
        type: boolean
        default: false
      typescript_only:
        description: 'Run only TypeScript conformance tests'
        type: boolean
        default: false
  push:
    branches:
      - main
      - canary
    paths:
      - 'libraries/python/mcp_use/server/**'
      - 'libraries/python/mcp_use/client/**'
      - 'libraries/python/pyproject.toml'
      - 'libraries/typescript/packages/mcp-use/src/server/**'
      - 'libraries/typescript/packages/mcp-use/package.json'
      - 'libraries/python/tests/integration/servers_for_testing/conformance_server.py'
      - 'libraries/python/tests/integration/clients_for_testing/conformance_client.py'
      - 'libraries/typescript/packages/mcp-use/examples/server/features/conformance/**'
      - '.github/workflows/conformance.yml'
  pull_request:
    branches:
      - main
      - canary
    paths:
      - 'libraries/python/mcp_use/server/**'
      - 'libraries/python/mcp_use/client/**'
      - 'libraries/python/pyproject.toml'
      - 'libraries/typescript/packages/mcp-use/src/server/**'
      - 'libraries/typescript/packages/mcp-use/package.json'
      - 'libraries/python/tests/integration/servers_for_testing/conformance_server.py'
      - 'libraries/python/tests/integration/clients_for_testing/conformance_client.py'
      - 'libraries/typescript/packages/mcp-use/examples/server/features/conformance/**'
      - '.github/workflows/conformance.yml'

permissions:
  contents: read
jobs:
  conformance-test:
    name: Run Conformance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Prepare Python
        if: ${{ github.event_name != 'workflow_dispatch' || !inputs.typescript_only }}
        working-directory: libraries/python
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Prepare TypeScript server
        if: ${{ github.event_name != 'workflow_dispatch' || !inputs.python_only }}
        working-directory: libraries/typescript
        run: |
          pnpm install
          pnpm build

      - name: Install TypeScript conformance server dependencies
        if: ${{ github.event_name != 'workflow_dispatch' || !inputs.python_only }}
        working-directory: libraries/typescript/packages/mcp-use/examples/server/features/conformance
        run: pnpm install

      - name: Build server list
        id: build-servers
        run: |
          SERVERS='['
          if [ "${{ github.event_name }}" != "workflow_dispatch" ] || [ "${{ inputs.typescript_only }}" != "true" ]; then
            SERVERS+='{"name":"python","start-command":"source .venv/bin/activate && python tests/integration/servers_for_testing/conformance_server.py --transport streamable-http --port 8000","url":"http://127.0.0.1:8000/mcp","working-directory":"libraries/python"}'
          fi
          if [ "${{ github.event_name }}" != "workflow_dispatch" ] || [ "${{ inputs.python_only }}" != "true" ]; then
            if [[ $SERVERS != '[' ]]; then
              SERVERS+=','
            fi
            SERVERS+='{"name":"typescript","start-command":"PORT=3000 npx tsx src/server.ts","url":"http://localhost:3000/mcp","working-directory":"libraries/typescript/packages/mcp-use/examples/server/features/conformance"}'
          fi
          SERVERS+=']'
          echo "servers=$SERVERS" >> $GITHUB_OUTPUT

      - name: Build client list
        id: build-clients
        run: |
          CLIENTS='['
          if [ "${{ github.event_name }}" != "workflow_dispatch" ] || [ "${{ inputs.typescript_only }}" != "true" ]; then
            CLIENTS+='{"name":"python-client","command":".venv/bin/python tests/integration/clients_for_testing/conformance_client.py","working-directory":"libraries/python"}'
          fi
          CLIENTS+=']'
          echo "clients=$CLIENTS" >> $GITHUB_OUTPUT

      - name: Run conformance tests
        uses: mcp-use/mcp-conformance-action@v1
        env:
          MCP_USE_ANONYMIZED_TELEMETRY: false
        with:
          mode: test
          test-type: both
          servers: ${{ steps.build-servers.outputs.servers }}
          clients: ${{ steps.build-clients.outputs.clients }}
          badge-gist-id: ${{ secrets.CONFORMANCE_GIST_ID }}
          badge-gist-token: ${{ secrets.GIST_SECRET }}
